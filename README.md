# Python Code Sandbox MCP Server

A secure, cross-platform MCP server for syntax checking and safe execution of Python code generated by local LLMs.

> *for seamless integration with LLM tools in VS Code, LM Studio, and other MCP-compatible interfaces.*

## üåü Overview

A lightweight, secure MCP server for safe interaction between local Large Language Models (LLMs) and Python code. 
Two critical functions:

1. **Syntax Validation** ‚Äî Checks Python code for syntax errors using AST parsing, without executing it.
2. **Sandboxed Execution** ‚Äî Runs code in a hardened, isolated environment with CPU, memory, and I/O restrictions.

Safety is the top priority, the server prevents malicious or unstable code from affecting your system, ideal for AI-assisted development workflows.

### ‚ú® Features

- ‚úÖ **Syntax Checker** ‚Äî Uses Python‚Äôs `ast` module to validate code structure safely
- ‚úÖ **Security Scanner** ‚Äî Blocks dangerous functions (`eval`, `exec`, `open`, `__import__`, etc.) and modules (`os`, `subprocess`, `sys`, etc.)
- ‚úÖ **Cross-Platform Sandbox** ‚Äî Works on Windows and Linux/macOS with OS-level resource limits:
  - Unix: Uses `resource.setrlimit()` for CPU and memory caps
  - Windows: Uses Job Objects (via `pywin32`) for process isolation
- ‚úÖ **Time & Memory Limits** ‚Äî Configurable timeouts and memory caps (default: 15s, 100MB)
- ‚úÖ **JSON Output** ‚Äî Standardized responses for easy integration with LLM tools
- ‚úÖ **MCP-Ready** ‚Äî Fully compatible with MCP protocol via `fastmcp`
- ‚úÖ **Editable Install** ‚Äî Install in development mode (`pip install -e .`) for live code editing
- ‚úÖ **No External Dependencies** ‚Äî Pure Python, minimal dependencies


### üìÅ Project Structure
```
python-mcp-sandbox/
‚îú‚îÄ‚îÄ python_code_sandbox/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ python_code_sandbox.py     # Main MCP server (check_syntax, test_code)
‚îÇ   ‚îú‚îÄ‚îÄ safe_executor.py           # Core sandbox execution engine
‚îÇ   ‚îî‚îÄ‚îÄ test_safe_executor.py      # Test module for the sandbox execution engine
‚îú‚îÄ‚îÄ pyproject.toml                 # Python packaging config
‚îú‚îÄ‚îÄ requirements.txt               # Dependencies
‚îî‚îÄ‚îÄ README.md                      # This file
```

## üì¶ Installation

### Prerequisites

- Python 3.8+
- pip

### Install the Server

```bash
# Clone the repository
git clone https://github.com/your-username/python-mcp-sandbox.git
cd python-mcp-sandbox

# Install in editable mode
pip install -e .
```

> üí° Windows users: For full resource isolation, install pywin32: 
> ```
> pip install pywin32
> ```

### Verify the source code
Run tests for ```safe_executor.py``` from the command line, make sure all 6 tests passed ok:
> ```
> python test_safe_executor.py
> ```

## üõ†Ô∏è Integration with LLM Tools (LM Studio)
This server integrates with any MCP-compatible interface (LM Studio, etc.) via the mcp.json configuration file.
```
{
  "mcpServers": {
    "python-code-sandbox": {
      "command": "python",
      "args": [
        "-m",
        "python_code_sandbox.python_code_sandbox"
      ]
    }
  }
}
```
> ‚úÖ Tip: The python-code-sandbox entry above points to the installed module. You can also use the full path to the script if preferred.

Once configured, your LLM tool can call two functions:
- ```check_syntax(code: str)``` ‚Äî Returns syntax validity and error details
- ```test_code(code: str, timeout: float = 15.0, cpu_limit_sec: float = 10.0, memory_limit_mb: int = 100)``` ‚Äî Executes code safely and returns output

## üîç How It Works  
1. Syntax Check (```check_syntax```)
- Parses code using ast.parse() ‚Äî no execution occurs
- Returns structured JSON with:
  - ```valid```: ```true```/```false```
  - ```error```, ```line```, ```offset```, ```context``` ‚Äî if invalid
2. Safe Execution (```test_code```)
- Step 1: Validates syntax
- Step 2: Scans for dangerous imports and function calls
- Step 3: Writes code to a temporary file
- Step 4: Launches a child process with:
  - Restricted environment (no open, no imports, no sys access)
  - CPU and memory limits
  - Output captured via io.StringIO
- Step 5: Returns JSON result:
```
{
  "stdout": "...",
  "stderr": "...",
  "exit_code": 0,
  "phase": "execution"
}
```
All dangerous modules (```os```, ```subprocess```, ```ctypes```, etc.) are removed from sys.modules before execution.

## üß™ Example Usage
**Request from LLM Tool:**
```
{
  "method": "test_code",
  "params": {
    "code": "print('Hello, world!')\nx = 1 / 0",
    "timeout": 10,
    "memory_limit_mb": 50
  }
}
```
**Response:**
```
{
  "stdout": "Hello, world!\n",
  "stderr": "ZeroDivisionError: division by zero\n",
  "exit_code": 1,
  "phase": "execution"
}
```

## üö´ Security Design
This server follows the principle of **defense in depth:**

|**LAYER**                     |**PROTECTION**                           |
|--------------------------|---------------------------------------|
|1. **AST Parsing**            | No code execution during syntax check |
|2. **Static Analysis** |Blocks known dangerous functions and modules |
|3. **Environment Sanitization** |Removes dangerous modules, overrides ```__import__```, disables ```open()``` |
|4. **Process Isolation** | Uses OS-level limits (Job Objects on Windows, resource on Unix) |
|5. **Time & Memory Caps** | Prevents infinite loops or memory exhaustion |
|6. **Output Sandboxing** | All output captured via buffers, no direct filesystem access |

Log files are written to your system‚Äôs temp directory:
- ```mcp_sandbox.log```
- ```mcp_sandbox_executor.log```


###  üìå Notes
- Windows: For full resource limits, install ```pywin32```. Without it, only ```timeout``` is enforced.
- Linux/macOS: Full resource control via resource module is available by default.
- No internet access is allowed ‚Äî the sandbox blocks all network calls.
- No file system access ‚Äî ```open()``` and ```pathlib``` are disabled.

### üìú License
Apache 2.0 ‚Äî see LICENSE for details.

#### üìß Author: 
Alexander Kazantsev (akazant@gmail.com )
